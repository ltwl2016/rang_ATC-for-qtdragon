%
o<rack_change> sub

M73 

G61

(print, Storing tool and pocket information in local variables)
#<newtool> = #<_selected_tool>
#<oldtool> = #<_current_tool>
#4000 = #<_selected_tool>

(print, oldtool=#<oldtool>)
(print, newtool=#<newtool>)

O100 if [#<_task> EQ 0]
        (print, Task is Null)
O100     return [999]
O100 endif


G90

G40

G49

M49


G53 G0 Z[#<_ini[AXIS_Z]MAX_LIMIT>-0.1]
(print, Moved safe Z)


o200 if [#<oldtool> EQ #<newtool>]

o200 elseif [#<oldtool> GT 0]

    o210 if [#<oldtool> GT 0]
        o220 if [#<oldtool> LE #<_ini[ATC]NUMPOCKETS>]
    
             o<unload_tool>call
            
        o220 else

            G53 G0 X #<_ini[ATC]CHANGEX> Y #<_ini[ATC]CHANGEY>
            G53 G0 Z #<_ini[ATC]CHANGEZ>

            T#<newtool>M6

        o220 endif

    o210 endif
     
o200 else

o200 endif

G53 G0 Z[#<_ini[AXIS_Z]MAX_LIMIT>-0.1]

o300 if [#<oldtool> EQ #<newtool>]

    ;M2

    M48
    
    
o300 elseif [#<newtool> GT 0]


    o310 if [#<newtool> GT 0]

        o320 if [#<newtool> LE #<_ini[ATC]NUMPOCKETS>]

            (print, Getting tool #<newtool> from rack at pocket #<newtool>)
            
            #4000 = #<newtool>
            
            G4 P0.2
            
            o<load_tool>call
            
            ;M64 P4
                
            M48

        o320 else 

            G53 G0 Z[#<_ini[AXIS_Z]MAX_LIMIT>-0.1]
            G53 G0 X[#<_ini[ATC]CHANGEX>] Y[#<_ini[ATC]CHANGEY>]
            G53 G0 Z[#<_ini[ATC]CHANGEZ>]
                
             ;M64 P4
            
            M48

            M6
            
            #4000 = #<newtool>
        o320 ENDIF

        G53 G0 Z[#<_ini[AXIS_Z]MAX_LIMIT>-0.1]
        G53 G0 X[#<_ini[TOOLSENSOR]X>] Y[#<_ini[TOOLSENSOR]Y>]
        

    o310 endif
o300 elseif [#<newtool> EQ 0]
    
o300 endif
M61 Q#4000
(print, End of Program)
o<rack_change> endsub [1]

M2
%
